<!DOCTYPE html>
<html lang="zh-CN">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)" />
<meta name="generator" content="Hugo 0.92.2" />
<link rel="shortcut icon" type="image/x-icon" href="/imgs/icons/favicon.ico">
<link rel="icon" type="image/x-icon" href="/imgs/icons/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/imgs/icons/favicon_16x16_next.png">
<link rel="icon" type="image/png" sizes="32x32" href="/imgs/icons/favicon_32_32_next.png">
<link rel="apple-touch-icon" sizes="180x180" href="/imgs/icons/apple_touch_icon_next.png">
<meta itemprop="name" content="带你走进Linux内核源码中最常见的数据结构之「mutex」" />
<meta itemprop="description" content="带你走进Linux内核源码中最常见的数据结构之「mutex」" />
<meta itemprop="datePublished" ZgotmplZ />
<meta itemprop="dateModified" ZgotmplZ />
<meta itemprop="image" content="https://www.kad8.com/imgs/hugo_next_avatar.png" />
<meta itemprop="keywords" content="kernel,mutex" />

<meta property="og:type" content="article" />
<meta property="og:title" content="带你走进Linux内核源码中最常见的数据结构之「mutex」" />
<meta property="og:description" content="带你走进Linux内核源码中最常见的数据结构之「mutex」" />
<meta property="og:image" content="/imgs/hugo_next_avatar.png" />
<meta property="og:image:width" content="312" />
<meta property="og:image:height" content="312" />
<meta property="og:image:type" content="image/jpeg/png/svg/jpg" />
<meta property="og:url" content="https://www.kad8.com/post/linux/linux-kernel-source-code-data-structure-mutex.html"/>
<meta property="og:site_name" content="北南南北" />
<meta property="og:locale" content="zh-CN"/>
<meta property="article:author" content="VxWorks OS" />
<meta property="article:published_time" content="2022-10-16 11:52:03 &#43;0800 &#43;0800" />
<meta property="article:modified_time" content="2022-10-16 16:43:23 &#43;0800 &#43;0800" />


  
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.1.2/css/all.min.css" />
  
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" />


<link rel="stylesheet" href="/css/main.min.bed81cc6ee3f425fbd72b31d4280bf88a2dcdd7e7c58051a5337db01f0181f80.css">
  <style type="text/css">
    .post-footer, .flinks-list-footer hr:after {
      content: "~ 我可是有底线的哟 ~";
    }
  </style>
  <script class="next-config" data-name="page" type="application/json">{"comments":false,"isHome":false,"isPage":true,"path":"linux-kernel-source-code-data-structure-mutex.html","permalink":"https://www.kad8.com/post/linux/linux-kernel-source-code-data-structure-mutex.html","title":"带你走进Linux内核源码中最常见的数据结构之「mutex」"}</script>
  <script type="text/javascript">
  document.addEventListener('DOMContentLoaded', () => {
    var script = document.createElement('script');
      
    script.charset = "UTF-8";
    script.src     = "https:\/\/busuanzi.ibruce.info\/busuanzi\/2.3\/busuanzi.pure.mini.js";
    script.async   = "true"

    document.head.appendChild(script);
  });
</script>




  <title>带你走进Linux内核源码中最常见的数据结构之「mutex」 - 北南南北</title>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage"  class="use-motion" >
  <div class="headband"></div>
  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner">
<div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">北南南北</h1>
      <i class="logo-line"></i>
    </a>
    
      <p class="site-subtitle" itemprop="description">Embedded World</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
      
      <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>

<nav class="site-nav">
  <ul class="main-menu menu">
    <li class="menu-item menu-item-home">
      <a href="/" class="hvr-icon-pulse " rel="section"><i class="fa fa-home hvr-icon"></i>首页
      </a>
    </li>
    <li class="menu-item menu-item-about">
      <a href="/about.html" class="hvr-icon-pulse " rel="section"><i class="fa fa-user hvr-icon"></i>关于
      </a>
    </li>
    <li class="menu-item menu-item-flinks">
      <a href="/flinks.html" class="hvr-icon-pulse " rel="section"><i class="fa fa-thumbs-up hvr-icon"></i>友情链接
      </a>
    </li>
    <li class="menu-item menu-item-archives">
      <a href="/archives/" class="hvr-icon-pulse " rel="section"><i class="fa fa-archive hvr-icon"></i>归档
        <span class="badge">43</span>
      </a>
    </li>
    <li class="menu-item menu-item-commonweal">
      <a href="https://www.pudn.club" class="hvr-icon-pulse " rel="section"><i class="fa fa-heartbeat hvr-icon"></i>赞助商
      </a>
    </li>
    <li class="menu-item menu-item-search">
      <a role="button" class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索
      </a>
    </li>
  </ul>
</nav>

  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>
    </div>
  </div>
      </div>
      <div class="toggle sidebar-toggle" role="button">
  <span class="toggle-line"></span>
  <span class="toggle-line"></span>
  <span class="toggle-line"></span>
</div>
<aside class="sidebar">
  
  <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
    <ul class="sidebar-nav">
      <li class="sidebar-nav-toc">
        文章目录
      </li>
      <li class="sidebar-nav-overview">
        站点概览
      </li>
    </ul>
    <div class="sidebar-panel-container">
      
      <div class="post-toc-wrap sidebar-panel">
        <div class="post-toc animated"><nav id="TableOfContents">
  <ul>
    <li><a href="#定义">定义</a>
      <ul>
        <li><a href="#mutex有什么缺点">mutex有什么缺点？</a></li>
        <li><a href="#什么时候应该使用mutex">什么时候应该使用mutex？</a></li>
        <li><a href="#mutex与spinlock的区别">mutex与spinlock的区别？</a></li>
      </ul>
    </li>
    <li><a href="#实现">实现</a>
      <ul>
        <li><a href="#上锁">上锁</a></li>
        <li><a href="#尝试上锁">尝试上锁</a></li>
        <li><a href="#释放锁">释放锁</a></li>
      </ul>
    </li>
    <li><a href="#实际案例">实际案例</a></li>
  </ul>
</nav></div>
      </div>
      
      <div class="site-overview-wrap sidebar-panel">
<div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="VxWorks OS"
      src="/imgs/hugo_next_avatar.png">
  <p class="site-author-name" itemprop="name">VxWorks OS</p>
  <div class="site-description" itemprop="description">Where there is embedded, there is VxWorks.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
    <div class="site-state-item site-state-posts">
      <a href="/archives/">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">
      <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span>
      </a>
    </div>
    <div class="site-state-item site-state-tags">
      <a href="/tags/">
        <span class="site-state-item-count">75</span>
        <span class="site-state-item-name">标签</span>
      </a>
    </div>
  </nav>
</div>
<div class="links-of-social site-overview-item animated">


  <span class="links-of-social-item">
    <a href="https://github.com/" title="Github → https://github.com/" rel="noopener" class="hvr-icon-pulse" target="_blank">
      <i class="fab fa-github fa-fw  hvr-icon "></i>Github
    </a>
  </span>
  <span class="links-of-social-item">
    <a href="https://www.zhihu.com/" title="知乎 → https://www.zhihu.com/" rel="noopener" class="hvr-icon-pulse" target="_blank">
      <i class="fa fa-book fa-fw  hvr-icon "></i>知乎
    </a>
  </span>
</div>
<div class="cc-license animated" itemprop="license">
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank" title="共享知识">
    <img src="/imgs/cc/big/by_nc_sa.svg" alt="共享知识">
  </a>
</div>
<div class="links-of-blogroll site-overview-item animated">
  <div class="links-of-blogroll-title">
    <i class="fa fa-globe fa-fw"></i>友情链接
  </div>
  <ul class="links-of-blogroll-list">
    <li class="links-of-blogroll-item">
      <a href="https://www.gaitpu.com" title="https://www.gaitpu.com" target="_blank">Google AI TPU</a>
    </li>
    <li class="links-of-blogroll-item">
      <a href="https://www.vxworks.net" title="https://www.vxworks.net" target="_blank">VxWorks俱乐部</a>
    </li>
  </ul>
</div>
      </div>
    </div>
   
  </div>
<div class="sidebar-card-widget">
  <div class="item-headline">
    <i class="fas fa-chart-line"></i>
    <span>网站资讯</span>
  </div>
  <div class="siteinfo">
    <div class="siteinfo-item">
      <div class="item-name"><i class="fa-solid fa-calendar-check"></i>已运行：</div>
      <div class="item-count" id="runTimes" data-publishdate="2021-06-03T11:52:18&#43;08:00"></div>
    </div>
      <div class="siteinfo-item">
        <div class="item-name">
          <i class="fas fa fa-user"></i>总访客数：
        </div>
        <div class="item-count" id="busuanzi_value_site_uv"></div>
      </div>
      <div class="siteinfo-item">
        <div class="item-name">
          <i class="fas fa fa-eye"></i>页面浏览：
        </div>
        <div class="item-count" id="busuanzi_value_site_pv"></div>
      </div>
    <div class="siteinfo-item">
      <div class="item-name"><i class="fa fa-font"></i>总字数：</div>
      <div class="item-count" id="wordsCount" data-count="11450"></div>
    </div>
    <div class="siteinfo-item">
      <div class="item-name"><i class="fa fa-mug-hot"></i>阅读约：</div>
      <div class="item-count" id="readTimes" data-times="82"></div>
    </div>
    <div class="siteinfo-item">
      <div class="item-name"><i class="fa fa-clock-rotate-left"></i>最后更新于：</div>
      <div class="item-count" id="last-push-date" data-lastpushdate="2023-03-19T04:31:28-04:00"></div>
    </div>
  </div>
</div>
</aside>
<div class="sidebar-dimmer"></div>

    </header>
    
    <div class="tool-buttons" >
  <a id="goto-comments" class="button goto-comments" href="#comments"  title="直达评论">
    <i class="fas fa-comments"></i>
  </a> 
  <div id="switch-theme" class="button" title="深浅模式切换">
    <i class="fas fa-adjust"></i>
  </div> 
  
  <div class="back-to-top" role="button" title="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div> 
</div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
    <div class="main-inner post posts-expand">
      
  <div class="post-block">
  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.kad8.com/post/linux/linux-kernel-source-code-data-structure-mutex.html">
    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/imgs/hugo_next_avatar.png">
      <meta itemprop="name" content="VxWorks OS">
    </span>
    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="VxWorks OS">
      <meta itemprop="description" content="Where there is embedded, there is VxWorks.">
    </span>
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="带你走进Linux内核源码中最常见的数据结构之「mutex」">
      <meta itemprop="description" content="带你走进Linux内核源码中最常见的数据结构之「mutex」">
    </span>
    <header class="post-header">
       <h1 class="post-title" itemprop="name headline">带你走进Linux内核源码中最常见的数据结构之「mutex」 </h1> <div class="post-meta-container">
  <div class="post-meta-items">
    


<span class="post-meta-item">
  <span class="post-meta-item-icon">
    <i class="far fa-calendar"></i>
  </span>
  <span class="post-meta-item-text">发表于：</span>
  <time title="发表于：2022-10-16 11:52:03 &#43;0800 &#43;0800" itemprop="dateCreated datePublished" datetime="2022-10-16 11:52:03 &#43;0800 &#43;0800">2022-10-16</time>
</span>
    

<span class="post-meta-item">
  <span class="post-meta-item-icon">
    <i class="far fa-calendar-check"></i>
  </span>
  <span class="post-meta-item-text">更新于：</span>
  <time title="修改时间：2022-10-16T16:43:23&#43;08:00" itemprop="dateModified" datetime="2022-10-16T16:43:23&#43;08:00">2022-10-16</time>
</span>
    
<span class="post-meta-item">
  <span class="post-meta-item-icon">
    <i class="far fa-folder-open"></i>
  </span>
  <span class="post-meta-item-text">分类于：</span>
  <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
    <a href="/categories/linux" itemprop="url" rel="index">
      <span itemprop="name">Linux</span>
    </a>
  </span>
</span>
  </div>
  <div class="post-meta-items">
    
<span class="post-meta-item" title="字数">
  <span class="post-meta-item-icon">
    <i class="far fa-file-word"></i>
  </span>
  <span class="post-meta-item-text">字数：</span><span>497</span>
</span>
    
<span class="post-meta-item" title="阅读">
  <span class="post-meta-item-icon">
    <i class="far fa-clock"></i>
  </span>
  <span class="post-meta-item-text">阅读：&asymp;</span>
  <span>3分钟</span>
</span>

    
<span class="post-meta-item" title="浏览">
  <span class="post-meta-item-icon">
    <i class="far fa-eye"></i>
  </span>
  <span class="post-meta-item-text">
  浏览：
  </span>
  <span id="busuanzi_value_page_pv" data-path="/post/linux/linux-kernel-source-code-data-structure-mutex.html"><i class="fa fa-sync fa-spin"></i></span>
</span>

  </div>
  
</div>

    </header>
    
    <div class="post-body  autonumber " itemprop="articleBody">
      
  <h2 id="定义">定义</h2>
<p>互斥锁（英语：Mutual exclusion，缩写 Mutex）是一种用于多线程编程中，防止两条线程同时对同一公共资源（比如全域变量）进行读写的机制。</p>
<p>该目的通过将代码切片成一个一个的**临界区域（critical section）**达成。临界区域指的是一块对公共资源进行存取的代码，并非一种机制或是算法。一个程序、进程、线程可以拥有多个临界区域，但是并不一定会应用互斥锁。</p>
<p>例如：一段代码（甲）正在分步修改一块数据。这时，另一条线程（乙）由于一些原因被唤醒。如果乙此时去读取甲正在修改的数据，而甲碰巧还没有完成整个修改过程，这个时候这块数据的状态就处在极大的不确定状态中，读取到的数据当然也是有问题的。更严重的情况是乙也往这块地方写数据，这样的一来，后果将变得不可收拾。因此，多个线程间共享的数据必须被保护。达到这个目的的方法，就是确保同一时间只有一个临界区域处于运行状态，而其他的临界区域，无论是读是写，都必须被挂起并且不能获得运行机会。</p>
<p>互斥锁实现多线程同步的核心思想是：有线程访问进程空间中的公共资源时，该线程执行“加锁”操作（将资源“锁”起来），阻止其它线程访问。访问完成后，该线程负责完成“解锁”操作，将资源让给其它线程。当有多个线程想访问资源时，谁最先完成“加锁”操作，谁就最先访问资源。</p>
<p>当有多个线程想访问“加锁”状态下的公共资源时，它们只能等待资源“解锁”，所有线程会排成一个等待（阻塞）队列。资源解锁后，操作系统会唤醒等待队列中的所有线程，第一个访问资源的线程会率先将资源“锁”起来，其它线程则继续等待。当有多个线程想访问“加锁”状态下的公共资源时，它们只能等待资源“解锁”，所有线程会排成一个等待（阻塞）队列。资源解锁后，操作系统会唤醒等待队列中的所有线程，第一个访问资源的线程会率先将资源“锁”起来，其它线程则继续等待。</p>
<p><img src="https://www.vxworks.net/images/kad8/linux-kernel-mutex.jpg" alt="Mutex"></p>
<h3 id="mutex有什么缺点">mutex有什么缺点？</h3>
<p>不同于mutex最初的设计与目的，现在的struct mutex是内核中最大的锁之一，比如在x86-64上，它差不多有32bytes的大小，而struct samaphore是24bytes，rw_semaphore为40bytes，更大的数据结构意味着占用更多的CPU缓存和更多的内存占用。</p>
<h3 id="什么时候应该使用mutex">什么时候应该使用mutex？</h3>
<p>除非mutex的严格语义要求不合适或者临界区域阻止锁的共享，否则相较于其他锁原语来说更倾向于使用mutex</p>
<h3 id="mutex与spinlock的区别">mutex与spinlock的区别？</h3>
<p><img src="https://www.vxworks.net/images/kad8/spinlock-versus-mutex.jpg" alt="spinlock versus mutex"></p>
<p>spinlock是让一个尝试获取它的线程在一个循环中等待的锁，线程在等待时会一直查看锁的状态。而mutex是一个可以让多个进程轮流分享相同资源的机制</p>
<p>spinlock通常短时间持有，mutex可以长时间持有</p>
<p>spinlock任务在等待锁释放时不可以睡眠，mutex可以</p>
<p>看到一个非常有意思的解释：</p>
<p>spinlock就像是坐在车后座的熊孩子，一直问“到了吗？到了吗？到了吗？…”</p>
<p>mutex就像一个司机返回的信号，说“我们到了！”</p>
<h2 id="实现">实现</h2>
<p>看一下Linux kernel-5.8是如何实现mutex的2 实现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> mutex {
  atomic_long_t    owner;
  spinlock_t    wait_lock;
<span style="color:#75715e">#ifdef CONFIG_MUTEX_SPIN_ON_OWNER
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> optimistic_spin_queue osq; <span style="color:#75715e">/* Spinner MCS lock */</span>
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> list_head  wait_list;
<span style="color:#75715e">#ifdef CONFIG_DEBUG_MUTEXES
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span>      <span style="color:#f92672">*</span>magic;
<span style="color:#75715e">#endif
</span><span style="color:#75715e">#ifdef CONFIG_DEBUG_LOCK_ALLOC
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> lockdep_map  dep_map;
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>};
</code></pre></div><p>可以看到，mutex使用了原子变量owner来追踪锁的状态，owner实际上是指向当前mutex锁拥有者的struct task_struct *指针，所以当锁没有被持有时，owner为NULL。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="color:#75715e">/*
</span><span style="color:#75715e"> * This is the control structure for tasks blocked on mutex,
</span><span style="color:#75715e"> * which resides on the blocked task&#39;s kernel stack:
</span><span style="color:#75715e"> * 表示等待队列wait_list中进程的结构体
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">struct</span> mutex_waiter {
  <span style="color:#66d9ef">struct</span> list_head  list;
  <span style="color:#66d9ef">struct</span> task_struct  <span style="color:#f92672">*</span>task;
  <span style="color:#66d9ef">struct</span> ww_acquire_ctx  <span style="color:#f92672">*</span>ww_ctx;
<span style="color:#75715e">#ifdef CONFIG_DEBUG_MUTEXES
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span>      <span style="color:#f92672">*</span>magic;
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>};
</code></pre></div><h3 id="上锁">上锁</h3>
<p>当要获取mutex时，通常有三种路径方式</p>
<p>fastpath: 通过 cmpxchg() 当前任务与所有者来尝试原子性的获取锁。这仅适用于无竞争的情况（cmpxchg() 检查 0UL，因此上面的所有 3 个状态位都必须为 0）。如果锁被争用，它会转到下一个可能的路径。</p>
<p>midpath: 又名乐观旋转（optimistic spinning）—在锁的持有者正在运行并且没有其他具有更高优先级（need_resched）的任务准备运行时，通过旋转来获取锁。理由是如果锁的所有者正在运行，它很可能很快就会释放锁。mutex spinner使用 MCS 锁排队，因此只有一个spinner可以竞争mutex。</p>
<p>MCS 锁（由 Mellor-Crummey 和 Scott 提出）是一个简单的自旋锁，具有公平的理想属性，每个 cpu 都试图获取在本地变量上旋转的锁，排队采用的是链表实现的FIFO。它避免了常见的test-and-set自旋锁实现引起的昂贵的cacheline bouncing。类似MCS的锁是专门为睡眠锁的乐观旋转而量身定制的（毕竟如果只是短暂的自旋比休眠效率要高）。自定义 MCS 锁的一个重要特性是它具有额外的属性，即当spinner需要重新调度时，它们能够直接退出 MCS 自旋锁队列。这有助于避免需要重新调度的 MCS spinner持续在mutex持有者上自旋，而仅需直接进入慢速路径获取MCS锁。</p>
<p>slowpath: 最后的手段，如果仍然无法获得锁，则将任务添加到等待队列并休眠，直到被解锁路径唤醒。在正常情况下它阻塞为 TASK_UNINTERRUPTIBLE。
虽然正式的内核互斥锁是可休眠的锁，但midpath路径 (ii) 使它们更实际地成为混合类型。通过简单地不中断任务并忙于等待几个周期而不是立即休眠，此锁的性能已被视为显着改善了许多工作负载。请注意，此技术也用于 rw 信号量。</p>
<p>具体代码调用链很长…</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="color:#75715e">/*不可中断的获取锁*/</span>
<span style="color:#66d9ef">void</span> __sched <span style="color:#a6e22e">mutex_lock</span>(<span style="color:#66d9ef">struct</span> mutex <span style="color:#f92672">*</span>lock)
{
    might_sleep();
    <span style="color:#75715e">/*fastpath*/</span>
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>__mutex_trylock_fast(lock))
        <span style="color:#75715e">/*midpath and slowpath*/</span>
        __mutex_lock_slowpath(lock);
}

__mutex_trylock_fast(lock) <span style="color:#f92672">-&gt;</span> atomic_long_try_cmpxchg_acquire(<span style="color:#f92672">&amp;</span>lock<span style="color:#f92672">-&gt;</span>owner, <span style="color:#f92672">&amp;</span>zero, curr) <span style="color:#f92672">-&gt;</span> atomic64_try_cmpxchg_acquire(v, (s64 <span style="color:#f92672">*</span>)old, new);

__mutex_lock_slowpath(lock)<span style="color:#f92672">-&gt;</span>__mutex_lock(lock, TASK_UNINTERRUPTIBLE, <span style="color:#ae81ff">0</span>, NULL, _RET_IP_) <span style="color:#f92672">-&gt;</span>  __mutex_lock_common(lock, state, subclass, nest_lock, ip, NULL, false)
  
  
<span style="color:#75715e">/*可中断的获取锁*/</span>
<span style="color:#66d9ef">int</span> mutex_lock_interruptible(<span style="color:#66d9ef">struct</span> mutex <span style="color:#f92672">*</span>lock);
</code></pre></div><h3 id="尝试上锁">尝试上锁</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> __sched <span style="color:#a6e22e">mutex_trylock</span>(<span style="color:#66d9ef">struct</span> mutex <span style="color:#f92672">*</span>lock)
{
  <span style="color:#66d9ef">bool</span> locked;

<span style="color:#75715e">#ifdef CONFIG_DEBUG_MUTEXES
</span><span style="color:#75715e"></span>  DEBUG_LOCKS_WARN_ON(lock<span style="color:#f92672">-&gt;</span>magic <span style="color:#f92672">!=</span> lock);
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
  locked <span style="color:#f92672">=</span> __mutex_trylock(lock);
  <span style="color:#66d9ef">if</span> (locked)
    mutex_acquire(<span style="color:#f92672">&amp;</span>lock<span style="color:#f92672">-&gt;</span>dep_map, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, _RET_IP_);

  <span style="color:#66d9ef">return</span> locked;
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">__mutex_trylock</span>(<span style="color:#66d9ef">struct</span> mutex <span style="color:#f92672">*</span>lock)
{
  <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span>__mutex_trylock_or_owner(lock);
}
</code></pre></div><h3 id="释放锁">释放锁</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> __sched <span style="color:#a6e22e">mutex_unlock</span>(<span style="color:#66d9ef">struct</span> mutex <span style="color:#f92672">*</span>lock)
{
<span style="color:#75715e">#ifndef CONFIG_DEBUG_LOCK_ALLOC
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (__mutex_unlock_fast(lock))
    <span style="color:#66d9ef">return</span>;
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>  __mutex_unlock_slowpath(lock, _RET_IP_);
}
<span style="color:#960050;background-color:#1e0010">跟加锁对称，也有</span>fastpath, midpath, slowpath三条路径<span style="color:#960050;background-color:#1e0010">。</span>
</code></pre></div><p>判断锁状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">mutex_is_locked</span>(<span style="color:#66d9ef">struct</span> mutex <span style="color:#f92672">*</span>lock)
{
  <span style="color:#66d9ef">return</span> __mutex_owner(lock) <span style="color:#f92672">!=</span> NULL;
}
</code></pre></div><p>很显而易见，mutex持有者不为NULL即表示锁定状态。</p>
<h2 id="实际案例">实际案例</h2>
<p>实验：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;pthread.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define LOOP 1000000
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">int</span> cs1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, cs2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">task</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> args) {
    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>)
    {
        <span style="color:#66d9ef">if</span>(cnt <span style="color:#f92672">&gt;=</span> LOOP)
        {
            <span style="color:#66d9ef">break</span>;
        }
        cnt<span style="color:#f92672">++</span>;
        <span style="color:#66d9ef">if</span>((<span style="color:#66d9ef">int</span>)args <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) cs1 <span style="color:#f92672">++</span>; <span style="color:#66d9ef">else</span> cs2<span style="color:#f92672">++</span>;
    }
    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    pthread_t tid1;
    pthread_t tid2;
    <span style="color:#75715e">/* create the thread */</span>
    pthread_create(<span style="color:#f92672">&amp;</span>tid1, NULL, task, (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">1</span>);
    pthread_create(<span style="color:#f92672">&amp;</span>tid2, NULL, task, (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">2</span>);
    <span style="color:#75715e">/* wait for thread to exit */</span>
    pthread_join(tid1, NULL);
    pthread_join(tid2, NULL);

    printf(<span style="color:#e6db74">&#34;cnt = %d cs1=%d cs2=%d total=%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, cnt,cs1,cs2,cs1<span style="color:#f92672">+</span>cs2);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000000</span> cs1<span style="color:#f92672">=</span><span style="color:#ae81ff">958560</span> cs2<span style="color:#f92672">=</span><span style="color:#ae81ff">1520226</span> total<span style="color:#f92672">=</span><span style="color:#ae81ff">2478786</span>
</code></pre></div><p>正确结果不应该是1000000吗？为什么会出错呢，我们可以从汇编角度来分析一下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">$&gt; g++ -E test.c -o test.i
$&gt; g++ -S test.i -o test.s
$&gt; vim test.s
  
.file <span style="color:#e6db74">&#34;test.c&#34;</span>
  .globl  _cnt
  .bss
  .align <span style="color:#ae81ff">4</span>
_cnt:
  .space <span style="color:#ae81ff">4</span>
  .text
  .globl  __Z5task1Pv
  .def  __Z5task1Pv;  .scl  2;  .type 32; .endef
__Z5task1Pv:
  ...

</code></pre></div><p>我们可以看到一个简单的cnt++，对应</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">movl  _cnt, %eax
addl  $1, %eax
movl  %eax, _cnt
</code></pre></div><p>CPU先将cnt的值读到寄存器eax中，然后将[eax] + 1，最后将eax的值返回到cnt中，这些操作不是**原子性质(atomic)**的，这就导致cnt被多个线程操作时，+1过程会被打断。</p>
<p>加入mutex保护临界资源</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;pthread.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define LOOP 1000000
</span><span style="color:#75715e"></span>
pthread_mutex_t mutex;
<span style="color:#66d9ef">int</span> cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">int</span> cs1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, cs2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">task</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> args) {
    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>)
    {
        pthread_mutex_lock(<span style="color:#f92672">&amp;</span>mutex);
        <span style="color:#66d9ef">if</span>(cnt <span style="color:#f92672">&gt;=</span> LOOP)
        {
            pthread_mutex_unlock(<span style="color:#f92672">&amp;</span>mutex);
            <span style="color:#66d9ef">break</span>;
        }
        cnt<span style="color:#f92672">++</span>;
        pthread_mutex_unlock(<span style="color:#f92672">&amp;</span>mutex);
        <span style="color:#66d9ef">if</span>((<span style="color:#66d9ef">int</span>)args <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) cs1 <span style="color:#f92672">++</span>; <span style="color:#66d9ef">else</span> cs2<span style="color:#f92672">++</span>;
    }
    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    pthread_mutex_init(<span style="color:#f92672">&amp;</span>mutex , NULL);
    pthread_t tid1;
    pthread_t tid2;
    <span style="color:#75715e">/* create the thread */</span>
    pthread_create(<span style="color:#f92672">&amp;</span>tid1, NULL, task, (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">1</span>);
    pthread_create(<span style="color:#f92672">&amp;</span>tid2, NULL, task, (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">2</span>);
    <span style="color:#75715e">/* wait for thread to exit */</span>
    pthread_join(tid1, NULL);
    pthread_join(tid2, NULL);

    printf(<span style="color:#e6db74">&#34;cnt = %d cs1=%d cs2=%d total=%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, cnt,cs1,cs2,cs1<span style="color:#f92672">+</span>cs2);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

</code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000000</span> cs1<span style="color:#f92672">=</span><span style="color:#ae81ff">517007</span> cs2<span style="color:#f92672">=</span><span style="color:#ae81ff">482993</span> total<span style="color:#f92672">=</span><span style="color:#ae81ff">1000000</span>
</code></pre></div>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1543398821442998"
     crossorigin="anonymous"></script>

<ins class="adsbygoogle"
     style="display:inline-block;width:970px;height:90px"
     data-ad-client="ca-pub-1543398821442998"
     data-ad-slot="4140563281"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>



    </div>
    <footer class="post-footer">
      

<div class="post-tags">
  
    <a href="/tags/kernel">
    kernel
  </a>
    <a href="/tags/mutex">
    mutex
  </a>
</div>

<div class="addthis_inline_share_toolbox" style="text-align: center;"></div>
<hr/>

<div class="reward-container">
  <div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div>
  <button>赞赏</button>
  <div class="post-reward">
    <div class="post-reward-item">
      <img src="/imgs/ali-pay.png" alt="VxWorks OS - 支付宝">
      <span>支付宝</span>
    </div>
    <div class="post-reward-item">
      <img src="/imgs/wechat-pay.png" alt="VxWorks OS - 微信">
      <span>微信</span>
    </div>
  </div>
</div>


<div class="post-copyright">
  <img src="/imgs/cc/cc.svg" width="75" height="75" align="right" />
  <ul>
    <li class="post-copyright-title">
      <strong>文章标题：</strong>
      带你走进Linux内核源码中最常见的数据结构之「mutex」
    </li>
    <li class="post-copyright-author">
      <strong>本文作者： </strong>
      VxWorks OS
    </li>
    <li class="post-copyright-link"> 
      <strong>本文链接：</strong>
       <a id="post-cr-link" href="https://www.kad8.com/post/linux/linux-kernel-source-code-data-structure-mutex.html" title="带你走进Linux内核源码中最常见的数据结构之「mutex」">https://www.kad8.com/post/linux/linux-kernel-source-code-data-structure-mutex.html</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target='_blank' href='https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh'>BY-NC-SA</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</div>

  <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>
  <div class="social-list">
    
    <div class="social-item">
        <a target="_blank" class="social-link" href="/imgs/wechat_channel.jpg">
          <span class="icon">
            <i class="fab fa-weixin"></i>
          </span>
          <span class="label">WeChat</span>
        </a>
      </div>
  </div>
</div>
<div class="post-nav">
  <div class="post-nav-next post-nav-item">
    <a href="/post/fpga/embedded-lcd-interface-model.html" rel="next" title="详解嵌入式LCD的接口类型">
      <i class="fa fa-chevron-left"></i> 详解嵌入式LCD的接口类型
    </a>
  </div>
  <div class="post-nav-prev post-nav-item">
    <a href="/post/linux/openssl.html" rel="prev" title="openssl命令">
      openssl命令
      <i class="fa fa-chevron-right"></i>
    </a>
  </div>
</div>
    </footer>
  </article>
</div>
<div id="comments" class="post-comments">
  <div class="comment-head">
    <div class="comment-headline">
      <i class="fas fa-comments fa-fw"></i>
      <span>评论交流</span>
    </div>
    <div class="comment-switch">
      <span class="first-comment">Giscus</span>
      <span class="switch-btn "></span>
      <span class="second-comment">Waline</span>
    </div>
  </div>
  <div class="comment-wrap">
  
    <div><div class="comment-loading">
  <i class="fa fa-sync fa-spin"></i>
</div><div class="giscus-container"></div>
    </div>
    <div><div class="comment-loading">
  <i class="fa fa-sync fa-spin"></i>
</div><div class="waline-container"></div>
    </div>
  </div>
</div>

    </div>
  </main>
  <footer class="footer">
    <div class="footer-inner">

<div class="copyright">
  &copy;
  <span itemprop="copyrightYear">
    2010 - 2023
  </span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">VxWorks OS</span>
</div>


    </div>
  </footer> 
  
  <script type="text/javascript" src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" defer></script>

<script class="next-config" data-name="main" type="application/json">{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://www.kad8.com","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"unpkg","router":"https://unpkg.com"},"version":"4.3.1","waline":{"cfg":{"emoji":false,"imguploader":false,"pageview":"#waline-pageview-count","placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.11.3"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.11.3"}}}</script>







<script type="text/javascript" src="/js/main.min.7e59cf1a98d842830d8a6f149f78fbbcf9e795b7a9eb76feb34b48c9bf1554d7.js" defer></script>











</body>

</html>